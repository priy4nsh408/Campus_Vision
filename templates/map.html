<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Campus Map ‚Äî RAG Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- ‚≠ê Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places,geometry,directions"></script>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .map-container {
      display: flex;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    
    #map {
      flex: 1;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .sidebar {
      width: 350px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      overflow-y: auto;
      padding: 20px;
      font-family: 'Inter', sans-serif;
    }
    
    .sidebar h2 {
      margin: 0 0 15px 0;
      color: #1f2937;
      font-size: 18px;
    }
    
    .location-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .location-input:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .btn-locate {
      width: 100%;
      padding: 10px;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 15px;
      transition: background 0.3s;
    }
    
    .btn-locate:hover {
      background: #3367D6;
    }
    
    .locations-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .location-item {
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: #f9fafb;
    }
    
    .location-item:hover {
      background: #f3f4f6;
      border-color: #4285F4;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .location-item.active {
      background: #DBEAFE;
      border-color: #4285F4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .location-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .location-category {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 3px;
    }
    
    .location-distance {
      font-size: 12px;
      color: #4285F4;
      font-weight: 500;
    }
    
    .location-description {
      font-size: 11px;
      color: #6b7280;
      margin-top: 5px;
      line-height: 1.3;
    }
    
    .top-section {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }
    
    .back-link {
      text-decoration: none;
      color: #4285F4;
      font-weight: 600;
      font-size: 14px;
      padding: 6px 12px;
      background: #DBEAFE;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .back-link:hover {
      background: #BFDBFE;
    }
    
    .user-info {
      font-size: 12px;
      color: #6b7280;
      padding: 10px;
      background: #f3f4f6;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .coordinates-input {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .coordinates-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      font-size: 12px;
      box-sizing: border-box;
    }
    
    .coordinates-input input:focus {
      outline: none;
      border-color: #4285F4;
    }
    
    .info-box {
      background: #EFF6FF;
      border-left: 4px solid #4285F4;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 12px;
      color: #1e40af;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: #6b7280;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .tab-btn.active {
      color: #4285F4;
      border-bottom-color: #4285F4;
    }
    
    .tab-btn:hover {
      color: #1f2937;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .direction-box {
      background: #FEF3C7;
      border-left: 4px solid #F59E0B;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 13px;
      color: #92400E;
    }
    
    .direction-step {
      padding: 10px;
      background: #f3f4f6;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #4285F4;
      font-size: 12px;
    }
    
    .direction-step.start {
      border-left-color: #34A853;
      background: #ECFDF5;
    }
    
    .direction-step.end {
      border-left-color: #EA4335;
      background: #FDECEC;
    }
    
    .direction-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .direction-stat {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }
    
    .direction-stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #4285F4;
      margin-bottom: 3px;
    }
    
    .direction-stat-label {
      color: #6b7280;
      font-size: 11px;
    }
    
    .direction-select {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .direction-select select {
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 13px;
      box-sizing: border-box;
      background-color: white;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      min-height: 40px;
    }
    
    .direction-select select:hover {
      border-color: #4285F4;
      box-shadow: 0 2px 4px rgba(66, 133, 244, 0.1);
    }
    
    .direction-select select:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    @media (max-width: 768px) {
      .map-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="map-container">
    <!-- Google Map -->
    <div id="map"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="top-section">
        <a href="/" class="back-link">‚Üê Back to Chat</a>
      </div>
      
      <h2>Campus Navigation</h2>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('search')">üîç Search</button>
        <button class="tab-btn" onclick="switchTab('directions')">üõ£Ô∏è Directions</button>
      </div>
      
      <!-- SEARCH TAB -->
      <div id="search-tab" class="tab-content active">
        <div class="info-box">
          üìç Enter your coordinates or use current location to find nearby departments
        </div>
        
        <div class="coordinates-input">
          <input type="number" id="inputLat" placeholder="Latitude" step="0.0001" value="{{ user_lat or 12.92468 }}">
          <input type="number" id="inputLng" placeholder="Longitude" step="0.0001" value="{{ user_lng or 77.498922 }}">
        </div>
        
        <button class="btn-locate" onclick="searchFromCoordinates()">üîç Find Nearby</button>
        <button class="btn-locate" onclick="getCurrentLocation()" style="background: #34A853;">üìç Current Location</button>
        
        <h3 style="margin-top: 20px; font-size: 14px; color: #1f2937;">Nearby Locations:</h3>
        <div class="locations-list" id="locationsList">
          <div style="text-align: center; color: #9ca3af; padding: 20px;">
            Click "Find Nearby" to see locations
          </div>
        </div>
      </div>

      
      
      <!-- DIRECTIONS TAB -->
      <div id="directions-tab" class="tab-content">
            <div id="directions">
  <!-- directions content -->
</div>
        <div class="info-box">
          üõ£Ô∏è Get turn-by-turn directions between two campus locations
        </div>
        
        <div class="direction-select">
          <div>
            <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 5px;">From:</label>
            <select id="directionFrom" onchange="updateDirectionsList('from')">
              <option value="">Select starting point</option>
            </select>
          </div>
          <div>
            <label style="font-size: 11px; color: #6b7280; display: block; margin-bottom: 5px;">To:</label>
            <select id="directionTo" onchange="updateDirectionsList('to')">
              <option value="">Select destination</option>
            </select>
          </div>
        </div>
        
        <button class="btn-locate" onclick="getDirections()" style="background: #F59E0B;">üõ£Ô∏è Get Directions</button>
        
        <div id="directionsResult" style="display: none; margin-top: 15px;">
          <div id="directionsInfo"></div>
          <div id="directionsSteps"></div>
        </div>
        
        <div id="noDirections" style="text-align: center; color: #9ca3af; padding: 20px;">
          Select two locations to see directions
        </div>
      </div>
    </div>
  </div>

  <script>
    let map;
    let userMarker;
    let locationMarkers = [];
    let infoWindows = [];
    
    const categoryColors = {
      'Academic Department': '#4285F4',
      'Academic Facility': '#34A853',
      'Academic Area': '#34A853',
      'Auditorium': '#FBBC04',
      'Activity Center': '#EA4335',
      'Administrative Building': '#9C27B0',
      'Facility': '#FF6D00',
      'Entrance': '#00BCD4'
    };

    // Initialize map
    function initMap() {
      const defaultCenter = { lat: 12.92468, lng: 77.498922 }; // Main Entrance
      
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 17,
        center: defaultCenter,
        mapTypeId: 'satellite',
        streetViewControl: true,
        fullscreenControl: true,
        zoomControl: true,
        mapTypeControl: true
      });
      
      // Load all campus locations
      loadAllLocations();
      
      // Populate direction dropdowns
      populateLocationDropdowns();
    }

    // Load all campus locations on the map
    function loadAllLocations() {
      const locations = {{ locations | tojson }};
      
      for (const [name, data] of Object.entries(locations)) {
        createLocationMarker(name, data);
      }
    }

    // Create marker for location
    function createLocationMarker(name, data) {
      const color = categoryColors[data.category] || '#4285F4';
      
      const marker = new google.maps.Marker({
        position: { lat: data.lat, lng: data.lng },
        map: map,
        title: name,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: color,
          fillOpacity: 0.8,
          strokeColor: '#ffffff',
          strokeWeight: 2
        }
      });
      
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="padding: 10px; font-family: Arial;">
            <strong>${name}</strong><br>
            <small style="color: #666;">${data.category}</small><br>
            <p style="margin: 8px 0 0 0; font-size: 12px;">${data.description}</p>
            <small style="color: #999;">üìç ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)}</small>
          </div>
        `
      });
      
      marker.addListener('click', () => {
        // Close all info windows
        infoWindows.forEach(iw => iw.close());
        infoWindow.open(map, marker);
      });
      
      locationMarkers.push(marker);
      infoWindows.push(infoWindow);
    }

    // Search from coordinates
    function searchFromCoordinates() {
      const lat = parseFloat(document.getElementById('inputLat').value);
      const lng = parseFloat(document.getElementById('inputLng').value);
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('Please enter valid coordinates');
        return;
      }
      
      findNearbyLocations(lat, lng);
    }

    // Get current location
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('inputLat').value = lat.toFixed(4);
            document.getElementById('inputLng').value = lng.toFixed(4);
            
            findNearbyLocations(lat, lng);
          },
          (error) => {
            alert('Error getting location: ' + error.message);
          }
        );
      } else {
        alert('Geolocation is not supported by your browser');
      }
    }

    // Find nearby locations via API
    function findNearbyLocations(lat, lng) {
      // Update user marker
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          position: { lat, lng },
          map: map,
          title: 'Your Location',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#FF6D00',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 3
          }
        });
      } else {
        userMarker.setPosition({ lat, lng });
      }
      
      // Center map
      map.setCenter({ lat, lng });
      
      // Fetch nearby locations
      fetch('/api/find-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lat, lng })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          displayNearbyLocations(data.nearest_locations);
        }
      })
      .catch(error => console.error('Error:', error));
    }

    // Display nearby locations in sidebar
    function displayNearbyLocations(locations) {
      const list = document.getElementById('locationsList');
      list.innerHTML = '';
      
      locations.forEach((loc, index) => {
        const div = document.createElement('div');
        div.className = 'location-item';
        div.innerHTML = `
          <div class="location-name">${loc.name}</div>
          <div class="location-category">${loc.category}</div>
          <div class="location-distance">üìç ${(loc.distance * 1000).toFixed(0)} meters away</div>
          <div class="location-description">${loc.description}</div>
        `;
        
        div.onclick = () => {
          // Center map on this location
          map.setCenter({ lat: loc.lat, lng: loc.lng });
          map.setZoom(18);
          
          // Remove previous selection
          document.querySelectorAll('.location-item').forEach(item => {
            item.classList.remove('active');
          });
          div.classList.add('active');
        };
        
        list.appendChild(div);
      });
    }

    // ========================================
    // üõ£Ô∏è DIRECTIONS SYSTEM
    // ========================================
    
    // Populate location dropdowns with all campus locations
    function populateLocationDropdowns() {
      const fromSelect = document.getElementById('directionFrom');
      const toSelect = document.getElementById('directionTo');
      const locations = {{ locations | tojson }};
      
      console.log('Populating dropdowns with locations:', Object.keys(locations));
      
      // Clear existing options (keep the default one)
      while (fromSelect.options.length > 1) {
        fromSelect.remove(1);
      }
      while (toSelect.options.length > 1) {
        toSelect.remove(1);
      }
      
      // Add all locations sorted
      const locationNames = Object.keys(locations).sort();
      locationNames.forEach(name => {
        // Add to "From" dropdown
        const option1 = document.createElement('option');
        option1.value = name;
        option1.textContent = name;
        fromSelect.appendChild(option1);
        
        // Add to "To" dropdown
        const option2 = document.createElement('option');
        option2.value = name;
        option2.textContent = name;
        toSelect.appendChild(option2);
      });
      
      console.log('Dropdown populated. From options:', fromSelect.options.length, 'To options:', toSelect.options.length);
    }
    
    // Switch between tabs
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      // Initialize directions dropdowns if needed
      if (tabName === 'directions') {
        populateLocationDropdowns();
      }
    }
    

    // Get directions between two locations
    function getDirections() {
      const fromLocation = document.getElementById('directionFrom').value;
      const toLocation = document.getElementById('directionTo').value;
      
      if (!fromLocation || !toLocation) {
        alert('Please select both starting point and destination');
        return;
      }
      
      if (fromLocation === toLocation) {
        alert('Please select different locations');
        return;
      }
      
      // Determine if waypoints are needed to avoid non-existent roads
      let waypoints = [];
      
      // Define route pairs that need to avoid RVU unit road via Admin Block or other waypoints
      const routePairsAvoidRVU = {
        // AIML & BT routes
        'AIML and BT Dept-Civil Dept': ['Admin Block'],
        'Civil Dept-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-CSE Dept': ['Admin Block'],
        'CSE Dept-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-Krishna Hostel': ['Admin Block'],
        'Krishna Hostel-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-Football & Cricket Ground': ['Admin Block'],
        'Football & Cricket Ground-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-ECE Dept': ['Admin Block'],
        'ECE Dept-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-EEE Dept': ['Admin Block'],
        'EEE Dept-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-Kriya Kalpa': ['Admin Block'],
        'Kriya Kalpa-AIML and BT Dept': ['Admin Block'],
        'AIML and BT Dept-Health Centre': ['Admin Block'],
        'Health Centre-AIML and BT Dept': ['Admin Block'],
        
        // MECH routes
        'Mechanical Dept-ECE Dept': ['Admin Block'],
        'ECE Dept-Mechanical Dept': ['Admin Block'],
        'Mechanical Dept-EEE Dept': ['Admin Block'],
        'EEE Dept-Mechanical Dept': ['Admin Block'],
        'Mechanical Dept-CSE Dept': ['Admin Block'],
        'CSE Dept-Mechanical Dept': ['Admin Block'],
        'Mechanical Dept-Football & Cricket Ground': ['Admin Block'],
        'Football & Cricket Ground-Mechanical Dept': ['Admin Block'],
        'Mechanical Dept-Krishna Hostel': ['Admin Block'],
        'Krishna Hostel-Mechanical Dept': ['Admin Block'],
        'Mechanical Dept-Health Centre': ['Admin Block'],
        'Health Centre-Mechanical Dept': ['Admin Block'],
        
        // BT Quad routes
        'Biotech Quadrangle-Civil Dept': ['Admin Block'],
        'Civil Dept-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-CSE Dept': ['Admin Block'],
        'CSE Dept-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-Krishna Hostel': ['Admin Block'],
        'Krishna Hostel-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-Football & Cricket Ground': ['Admin Block'],
        'Football & Cricket Ground-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-ECE Dept': ['Admin Block'],
        'ECE Dept-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-EEE Dept': ['Admin Block'],
        'EEE Dept-Biotech Quadrangle': ['Admin Block'],
        'Biotech Quadrangle-Health Centre': ['Admin Block'],
        'Health Centre-Biotech Quadrangle': ['Admin Block'],
      };
      
      // Check if this route needs waypoint to avoid RVU unit road
      const routeKey = fromLocation + '-' + toLocation;
      if (routePairsAvoidRVU[routeKey]) {
        waypoints = routePairsAvoidRVU[routeKey];
        console.log(`Adding waypoint (${waypoints.join(', ')}) to avoid non-existent RVU unit road for route: ${fromLocation} ‚Üí ${toLocation}`);
      }
      
      // Fetch directions from API
      fetch('/api/get-directions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    origin: fromLocation,
    destination: toLocation,
    waypoints: waypoints
  })
})
.then(async response => {
  const contentType = response.headers.get("content-type");

  if (!response.ok) {
    const text = await response.text();
    throw new Error(`Server error ${response.status}: ${text}`);
  }

  if (!contentType || !contentType.includes("application/json")) {
    const text = await response.text();
    throw new Error("Expected JSON, received HTML:\n" + text.substring(0, 100));
  }

  return response.json();
})
.then(data => {
  console.log('Directions API response:', data);

  if (data.success && data.directions) {
    displayDirections(data.directions);
  } else {
    alert('Error: ' + (data.error || 'Unknown error'));
  }
})
.catch(error => {
  console.error('Directions Fetch Error:', error);
  alert('Error getting directions:\n' + error.message);
});

    }
    
    // Display directions
    function displayDirections(directions) {
      console.log('=== Display Directions Called ===');
      console.log('Full directions object:', directions);
      console.log('Type of directions:', typeof directions);
      
      if (!directions) {
        console.error('ERROR: directions is null or undefined');
        alert('Error: No directions data received');
        return;
      }
      
      const resultDiv = document.getElementById('directionsResult');
      const infoDiv = document.getElementById('directionsInfo');
      const stepsDiv = document.getElementById('directionsSteps');
      const noDirectionsDiv = document.getElementById('noDirections');
      
      console.log('DOM elements:', {resultDiv, infoDiv, stepsDiv, noDirectionsDiv});
      
      // Hide "no directions" message
      noDirectionsDiv.style.display = 'none';
      resultDiv.style.display = 'block';
      
      // Extract data
      const distance = directions.distance;
      const duration = directions.duration;
      const origin = directions.origin;
      const destination = directions.destination;
      
      console.log('Extracted data:', {distance, duration, origin, destination});
      
      // Format distance and duration - handle string format from Google API
      let distanceText = distance;
      let durationText = duration;
      
      if (typeof distance === 'object' && distance !== null) {
        distanceText = distance.kilometers ? `${distance.kilometers} km` : `${distance.meters}m`;
      }
      if (typeof duration === 'object' && duration !== null) {
        durationText = duration.text || `${duration.minutes} minutes`;
      }
      
      console.log('Formatted text:', {distanceText, durationText});
      
      infoDiv.innerHTML = `
        <div class="direction-box">
          <strong>üìç From:</strong> ${origin.name}<br>
          <strong>üìç To:</strong> ${destination.name}
        </div>
        
        <div class="direction-info">
          <div class="direction-stat">
            <div class="direction-stat-value">${distanceText}</div>
            <div class="direction-stat-label">Distance</div>
          </div>
          <div class="direction-stat">
            <div class="direction-stat-value">${durationText}</div>
            <div class="direction-stat-label">Time</div>
          </div>
        </div>
      `;
      
      // Build steps display
      stepsDiv.innerHTML = '<strong style="display: block; margin-bottom: 10px;">üõ£Ô∏è Route Instructions:</strong>';
      if (directions.steps && directions.steps.length > 0) {
        console.log('Processing steps:', directions.steps);
        directions.steps.forEach((step, idx) => {
          const stepDiv = document.createElement('div');
          const isFirst = idx === 0;
          const isLast = idx === directions.steps.length - 1;
          const stepClass = isFirst ? 'start' : (isLast ? 'end' : '');
          
          let stepHTML = `<strong>Step ${step.number}:</strong> ${step.instruction}`;
          if (step.distance) {
            stepHTML += `<br><small>üìè ${step.distance} | ‚è±Ô∏è ${step.duration}</small>`;
          }
          
          stepDiv.className = `direction-step ${stepClass}`;
          stepDiv.innerHTML = stepHTML;
          stepsDiv.appendChild(stepDiv);
        });
      } else {
        console.warn('No steps found in directions');
      }
      
      // Draw route on map
      console.log('Drawing route with polyline:', directions.polyline ? 'Present' : 'Not present');
      drawDirectionRoute(origin, destination, directions.polyline);
    }
    
    // Decode Google polyline
    function decodePolyline(encoded) {
      let poly = [];
      let index = 0, lat = 0, lng = 0;
      while (index < encoded.length) {
        let result = 0, shift = 0, b;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += dlat;
        
        result = 0;
        shift = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += dlng;
        
        poly.push({lat: lat / 1e5, lng: lng / 1e5});
      }
      return poly;
    }
    
    // Draw direction route on map with actual Google route polyline
    function drawDirectionRoute(origin, destination, encodedPolyline) {
      // Clear previous polylines and markers
      if (window.directionPolyline) {
        window.directionPolyline.setMap(null);
      }
      if (window.originMarker) {
        window.originMarker.setMap(null);
      }
      if (window.destinationMarker) {
        window.destinationMarker.setMap(null);
      }
      
      // Decode polyline and create path
      let path = [];
      if (encodedPolyline) {
        path = decodePolyline(encodedPolyline);
      } else {
        // Fallback to straight line if no polyline
        path = [
          { lat: origin.lat, lng: origin.lng },
          { lat: destination.lat, lng: destination.lng }
        ];
      }
      
      // Draw polyline on map
      window.directionPolyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#F59E0B',
        strokeOpacity: 0.9,
        strokeWeight: 4,
        map: map
      });
      
      // Add origin marker (green)
      window.originMarker = new google.maps.Marker({
        position: { lat: origin.lat, lng: origin.lng },
        map: map,
        title: `Start: ${origin.name}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: '#34A853',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 2
        }
      });
      
      // Add destination marker (red)
      window.destinationMarker = new google.maps.Marker({
        position: { lat: destination.lat, lng: destination.lng },
        map: map,
        title: `End: ${destination.name}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: '#EA4335',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 2
        }
      });
      
      // Center map on route
      const bounds = new google.maps.LatLngBounds();
      path.forEach(point => bounds.extend(point));
      map.fitBounds(bounds);
      map.setZoom(Math.max(17, map.getZoom()));
    }
    
    function updateDirectionsList(type) {
      // Update placeholder or validation if needed
    }

    // Initialize on load
    window.addEventListener('load', initMap);
  </script>
</body>
</html>
